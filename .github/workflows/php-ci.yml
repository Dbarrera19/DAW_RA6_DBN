name: PHP CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  syntax-check:
    name: Verificar sintaxis PHP
    runs-on: ubuntu-latest

    steps:
    - name: Checkout código
      uses: actions/checkout@v3

    - name: Configurar PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.1'
        tools: composer

    - name: Validar sintaxis PHP
      run: |
        find . -name "*.php" -type f ! -path "./vendor/*" -print0 | xargs -0 -n1 php -l
      continue-on-error: true

  code-quality:
    name: Análisis de calidad del código
    runs-on: ubuntu-latest
    needs: syntax-check

    steps:
    - name: Checkout código
      uses: actions/checkout@v3

    - name: Configurar PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.1'
        tools: composer

    - name: Instalar dependencias
      run: composer install --no-progress --prefer-dist

    - name: Verificar PSR-12
      run: composer lint || echo "Se recomienda seguir PSR-12"
      continue-on-error: true

  documentation:
    name: Generar documentación
    runs-on: ubuntu-latest
    needs: syntax-check

    steps:
    - name: Checkout código
      uses: actions/checkout@v3

    - name: Configurar PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.1'
        tools: composer

    - name: Instalar phpDocumentor
      run: composer require --dev phpdocumentor/phpdocumentor

    - name: Generar documentación
      run: vendor/bin/phpdoc
      continue-on-error: true

    - name: Verificar documentación generada
      run: |
        if [ -d "docs/html" ]; then
          echo "✓ Documentación HTML generada exitosamente"
          ls -la docs/html/
        else
          echo "⚠ La documentación HTML no se generó"
        fi

  test:
    name: Pruebas básicas
    runs-on: ubuntu-latest
    needs: syntax-check

    steps:
    - name: Checkout código
      uses: actions/checkout@v3

    - name: Configurar PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.1'

    - name: Ejecutar index.php
      run: php -r "require 'index.php';" || echo "⚠ Verificar manualmente en navegador"
      continue-on-error: true

  report:
    name: Resumen del análisis
    runs-on: ubuntu-latest
    needs: [syntax-check, code-quality, documentation, test]
    if: always()

    steps:
    - name: Resumen de ejecución
      run: |
        echo "=== RESUMEN DE CI/CD ==="
        echo "✓ Verificación de sintaxis completada"
        echo "✓ Análisis de calidad completado"
        echo "✓ Documentación procesada"
        echo "✓ Pruebas básicas ejecutadas"
        echo ""
        echo "Próximos pasos:"
        echo "1. Revisar los logs completos"
        echo "2. Descargar documentación HTML si es necesario"
        echo "3. Hacer push para desencadenar nuevamente el workflow"
